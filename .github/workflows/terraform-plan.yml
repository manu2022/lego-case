name: Terraform Plan

on:
  pull_request:
    branches: [main]
    paths: ['terraform/**', '.github/workflows/terraform-*.yml']
  workflow_dispatch:

jobs:
  plan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    defaults:
      run:
        working-directory: terraform
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0

      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Plan
        id: plan
        env:
          ARM_ACCESS_KEY: ${{ secrets.TF_BACKEND_STORAGE_KEY }}
        run: |
          cat > terraform.tfvars << EOF
          resource_group_name = "rg-case"
          openai_api_key      = "${{ secrets.OPENAI_API_KEY }}"
          langfuse_secret_key = "${{ secrets.LANGFUSE_SECRET_KEY }}"
          langfuse_public_key = "${{ secrets.LANGFUSE_PUBLIC_KEY }}"
          langfuse_base_url   = "${{ secrets.LANGFUSE_BASE_URL }}"
          EOF
          
          terraform init \
            -backend-config="resource_group_name=${{ secrets.TF_BACKEND_RESOURCE_GROUP }}" \
            -backend-config="storage_account_name=${{ secrets.TF_BACKEND_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.TF_BACKEND_CONTAINER }}" \
            -backend-config="key=lego-case.tfstate"
          
          terraform validate
          terraform plan -out=tfplan -no-color | tee plan.txt
        continue-on-error: true

      - name: Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let plan;
            try {
              plan = fs.readFileSync('terraform/plan.txt', 'utf8');
            } catch (e) {
              plan = 'Plan unavailable';
            }
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `#### Terraform Plan\n<details><summary>Show Plan</summary>\n\n\`\`\`terraform\n${plan}\n\`\`\`\n</details>`
            });

      - if: steps.plan.outcome == 'failure'
        run: exit 1

