name: Deploy to Production

on:
  push:
    branches: [main]
    paths: ['terraform/**', 'backend/**', '.github/workflows/deploy-*.yml']
  workflow_dispatch:

env:
  RG_NAME: rg-case

jobs:
  infrastructure:
    runs-on: ubuntu-latest
    environment: production
    defaults:
      run:
        working-directory: terraform
    outputs:
      registry: ${{ steps.resources.outputs.registry }}
      app_name: ${{ steps.resources.outputs.app_name }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check Terraform changes
        id: changes
        run: |
          if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q '^terraform/'; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - uses: hashicorp/setup-terraform@v3
        if: steps.changes.outputs.changed == 'true'
        with:
          terraform_version: 1.9.0
          terraform_wrapper: false

      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Apply Terraform
        if: steps.changes.outputs.changed == 'true'
        env:
          ARM_ACCESS_KEY: ${{ secrets.TF_BACKEND_STORAGE_KEY }}
        run: |
          cat > terraform.tfvars << EOF
          resource_group_name = "rg-case"
          openai_api_key      = "${{ secrets.OPENAI_API_KEY }}"
          langfuse_secret_key = "${{ secrets.LANGFUSE_SECRET_KEY }}"
          langfuse_public_key = "${{ secrets.LANGFUSE_PUBLIC_KEY }}"
          langfuse_base_url   = "${{ secrets.LANGFUSE_BASE_URL }}"
          EOF
          
          terraform init \
            -backend-config="resource_group_name=${{ secrets.TF_BACKEND_RESOURCE_GROUP }}" \
            -backend-config="storage_account_name=${{ secrets.TF_BACKEND_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.TF_BACKEND_CONTAINER }}" \
            -backend-config="key=lego-case.tfstate"
          
          terraform validate
          terraform plan -out=tfplan
          terraform apply -auto-approve tfplan

      - name: Get resources
        id: resources
        run: |
          echo "registry=$(az acr list --resource-group $RG_NAME --query "[0].name" -o tsv)" >> $GITHUB_OUTPUT
          echo "app_name=$(az webapp list --resource-group $RG_NAME --query "[0].name" -o tsv)" >> $GITHUB_OUTPUT

  application:
    runs-on: ubuntu-latest
    needs: infrastructure
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Check backend changes
        id: changes
        run: |
          if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q '^backend/'; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - uses: azure/login@v2
        if: steps.changes.outputs.changed == 'true'
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Build and push
        if: steps.changes.outputs.changed == 'true'
        working-directory: backend
        run: |
          VERSION=$([ -f version.txt ] && cat version.txt || echo "0.1.0")
          IFS='.' read -r major minor patch <<< "$VERSION"
          NEW_VERSION="$major.$minor.$((patch + 1))"
          
          az acr build \
            --registry ${{ needs.infrastructure.outputs.registry }} \
            --image question-answer-api:${NEW_VERSION} \
            --image question-answer-api:latest \
            .
          
          echo $NEW_VERSION > version.txt

      - name: Update version
        if: steps.changes.outputs.changed == 'true'
        working-directory: backend
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add version.txt
          git diff --staged --quiet || (
            git commit -m "chore: bump version [skip ci]"
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:${{ github.ref }}
          )

      - name: Deploy
        if: steps.changes.outputs.changed == 'true'
        run: |
          az webapp config container set \
            --name ${{ needs.infrastructure.outputs.app_name }} \
            --resource-group $RG_NAME \
            --docker-custom-image-name ${{ needs.infrastructure.outputs.registry }}.azurecr.io/question-answer-api:latest \
            --docker-registry-server-url https://${{ needs.infrastructure.outputs.registry }}.azurecr.io
          
          az webapp restart --name ${{ needs.infrastructure.outputs.app_name }} --resource-group $RG_NAME

      - name: Health check
        if: steps.changes.outputs.changed == 'true'
        run: |
          APP_URL=$(az webapp show --name ${{ needs.infrastructure.outputs.app_name }} --resource-group $RG_NAME --query defaultHostName -o tsv)
          
          for i in {1..10}; do
            sleep 10
            curl -sf https://${APP_URL}/health > /dev/null && exit 0
            echo "Attempt $i/10..."
          done
          exit 1

