name: Deploy to Production

on:
  push:
    branches: [main]
    paths: ['terraform/**', 'backend/**', 'frontend/**', '.github/workflows/deploy-*.yml']
  pull_request:
    branches: [main]
    types: [closed]
    paths: ['terraform/**', 'backend/**', 'frontend/**']
  workflow_dispatch:

env:
  RG_NAME: rg-case

jobs:
  infrastructure:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true) || github.event_name == 'workflow_dispatch'
    environment: production
    defaults:
      run:
        working-directory: terraform
    outputs:
      terraform_changed: ${{ steps.changes.outputs.changed }}
      registry: ${{ steps.resources.outputs.registry }}
      backend_app_name: ${{ steps.resources.outputs.backend_app_name }}
      frontend_app_name: ${{ steps.resources.outputs.frontend_app_name }}
      backend_url: ${{ steps.resources.outputs.backend_url }}
      frontend_url: ${{ steps.resources.outputs.frontend_url }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check Terraform changes
        id: changes
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] || git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q '^terraform/'; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - uses: hashicorp/setup-terraform@v3
        if: steps.changes.outputs.changed == 'true'
        with:
          terraform_version: 1.9.0
          terraform_wrapper: false

      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Apply Terraform
        if: steps.changes.outputs.changed == 'true'
        env:
          ARM_ACCESS_KEY: ${{ secrets.TF_BACKEND_STORAGE_KEY }}
        run: |
          cat > terraform.tfvars << EOF
          resource_group_name = "rg-case"
          openai_api_key      = "${{ secrets.OPENAI_API_KEY }}"
          claude_api_key      = "${{ secrets.CLAUDE_API_KEY }}"
          langfuse_secret_key = "${{ secrets.LANGFUSE_SECRET_KEY }}"
          langfuse_public_key = "${{ secrets.LANGFUSE_PUBLIC_KEY }}"
          langfuse_base_url   = "${{ secrets.LANGFUSE_BASE_URL }}"
          EOF
          
          terraform init \
            -backend-config="resource_group_name=${{ secrets.TF_BACKEND_RESOURCE_GROUP }}" \
            -backend-config="storage_account_name=${{ secrets.TF_BACKEND_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.TF_BACKEND_CONTAINER }}" \
            -backend-config="key=lego-case.tfstate"
          
          terraform validate
          terraform plan -out=tfplan
          terraform apply -auto-approve tfplan

      - name: Get Azure resources
        id: resources
        run: |
          REGISTRY=$(az acr list --resource-group $RG_NAME --query "[0].name" -o tsv)
          BACKEND_APP=$(az webapp list --resource-group $RG_NAME --query "[?name=='question-answer-api'].name" -o tsv)
          FRONTEND_APP=$(az webapp list --resource-group $RG_NAME --query "[?name=='question-answer-frontend'].name" -o tsv)
          BACKEND_URL=$(az webapp show --name question-answer-api --resource-group $RG_NAME --query defaultHostName -o tsv)
          FRONTEND_URL=$(az webapp show --name question-answer-frontend --resource-group $RG_NAME --query defaultHostName -o tsv)
          
          echo "registry=$REGISTRY" >> $GITHUB_OUTPUT
          echo "backend_app_name=$BACKEND_APP" >> $GITHUB_OUTPUT
          echo "frontend_app_name=$FRONTEND_APP" >> $GITHUB_OUTPUT
          echo "backend_url=$BACKEND_URL" >> $GITHUB_OUTPUT
          echo "frontend_url=$FRONTEND_URL" >> $GITHUB_OUTPUT

  backend:
    runs-on: ubuntu-latest
    needs: infrastructure
    if: always() && needs.infrastructure.result == 'success'
    outputs:
      backend_changed: ${{ steps.changes.outputs.changed }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Check backend changes
        id: changes
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] || git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q '^backend/'; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Update backend env vars
        run: |
          az webapp config appsettings set \
            --name ${{ needs.infrastructure.outputs.backend_app_name }} \
            --resource-group $RG_NAME \
            --settings \
              OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
              CLAUDE_API_KEY="${{ secrets.CLAUDE_API_KEY }}" \
              LANGFUSE_SECRET_KEY="${{ secrets.LANGFUSE_SECRET_KEY }}" \
              LANGFUSE_PUBLIC_KEY="${{ secrets.LANGFUSE_PUBLIC_KEY }}" \
              LANGFUSE_BASE_URL="${{ secrets.LANGFUSE_BASE_URL }}" \
              CORS_ORIGINS="https://${{ needs.infrastructure.outputs.frontend_url }}" \
            > /dev/null

      - name: Build and deploy backend
        if: steps.changes.outputs.changed == 'true'
        working-directory: backend
        run: |
          VERSION=$([ -f version.txt ] && cat version.txt || echo "0.1.0")
          IFS='.' read -r major minor patch <<< "$VERSION"
          NEW_VERSION="$major.$minor.$((patch + 1))"
          
          az acr build \
            --registry ${{ needs.infrastructure.outputs.registry }} \
            --image question-answer-api:${NEW_VERSION} \
            --image question-answer-api:latest \
            .
          
          echo $NEW_VERSION > version.txt
          
          az webapp sitecontainers update \
            --name ${{ needs.infrastructure.outputs.backend_app_name }} \
            --resource-group $RG_NAME \
            --container-name main \
            --image ${{ needs.infrastructure.outputs.registry }}.azurecr.io/question-answer-api:latest \
            --target-port 8000 \
            --is-main true
          
          az webapp restart --name ${{ needs.infrastructure.outputs.backend_app_name }} --resource-group $RG_NAME

      - name: Commit version
        if: steps.changes.outputs.changed == 'true'
        working-directory: backend
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add version.txt
          git diff --staged --quiet && exit 0
          
          for i in {1..3}; do
            git commit -m "chore: bump backend version [skip ci]" || true
            git pull --rebase origin ${{ github.ref_name }} || true
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:${{ github.ref_name }} && exit 0
            sleep 2
          done
          exit 0

      - name: Backend health check
        if: steps.changes.outputs.changed == 'true'
        run: |
          sleep 15
          for i in {1..12}; do
            curl -sf https://${{ needs.infrastructure.outputs.backend_url }}/health > /dev/null 2>&1 && echo "âœ… Backend healthy" && exit 0
            echo "â³ Backend $i/12..."
            sleep 10
          done
          echo "âš ï¸ Backend health check timeout"

  frontend:
    runs-on: ubuntu-latest
    needs: infrastructure
    if: always() && needs.infrastructure.result == 'success'
    outputs:
      frontend_changed: ${{ steps.changes.outputs.changed }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Check frontend changes
        id: changes
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] || git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q '^frontend/'; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Update frontend env vars
        run: |
          az webapp config appsettings set \
            --name ${{ needs.infrastructure.outputs.frontend_app_name }} \
            --resource-group $RG_NAME \
            --settings \
              VITE_API_URL="https://${{ needs.infrastructure.outputs.backend_url }}" \
            > /dev/null

      - name: Build and deploy frontend
        if: steps.changes.outputs.changed == 'true'
        working-directory: frontend
        run: |
          VERSION=$([ -f version.txt ] && cat version.txt || echo "0.1.0")
          IFS='.' read -r major minor patch <<< "$VERSION"
          NEW_VERSION="$major.$minor.$((patch + 1))"
          
          az acr build \
            --registry ${{ needs.infrastructure.outputs.registry }} \
            --image question-answer-frontend:${NEW_VERSION} \
            --image question-answer-frontend:latest \
            .
          
          echo $NEW_VERSION > version.txt
          
          az webapp sitecontainers update \
            --name ${{ needs.infrastructure.outputs.frontend_app_name }} \
            --resource-group $RG_NAME \
            --container-name main \
            --image ${{ needs.infrastructure.outputs.registry }}.azurecr.io/question-answer-frontend:latest \
            --target-port 80 \
            --is-main true
          
          az webapp restart --name ${{ needs.infrastructure.outputs.frontend_app_name }} --resource-group $RG_NAME

      - name: Commit version
        if: steps.changes.outputs.changed == 'true'
        working-directory: frontend
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add version.txt
          git diff --staged --quiet && exit 0
          
          for i in {1..3}; do
            git commit -m "chore: bump frontend version [skip ci]" || true
            git pull --rebase origin ${{ github.ref_name }} || true
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:${{ github.ref_name }} && exit 0
            sleep 2
          done
          exit 0

      - name: Frontend health check
        if: steps.changes.outputs.changed == 'true'
        run: |
          sleep 15
          for i in {1..12}; do
            curl -sf https://${{ needs.infrastructure.outputs.frontend_url }} > /dev/null 2>&1 && echo "âœ… Frontend healthy" && exit 0
            echo "â³ Frontend $i/12..."
            sleep 10
          done
          echo "âš ï¸ Frontend health check timeout"

  summary:
    runs-on: ubuntu-latest
    needs: [infrastructure, backend, frontend]
    if: always() && needs.infrastructure.result == 'success'
    steps:
      - name: Deployment summary
        run: |
          echo "ğŸ‰ Deployment Complete!"
          echo ""
          [ "${{ needs.infrastructure.outputs.terraform_changed }}" == "true" ] && echo "âœ… Infrastructure updated"
          [ "${{ needs.backend.outputs.backend_changed }}" == "true" ] && echo "âœ… Backend deployed"
          [ "${{ needs.frontend.outputs.frontend_changed }}" == "true" ] && echo "âœ… Frontend deployed"
          echo ""
          echo "ğŸ“± Frontend: https://${{ needs.infrastructure.outputs.frontend_url }}"
          echo "ğŸ”Œ Backend: https://${{ needs.infrastructure.outputs.backend_url }}"
