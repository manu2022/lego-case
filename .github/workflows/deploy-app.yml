name: Deploy Application

on:
  push:
    branches: [main]
    paths: ['backend/**', '.github/workflows/deploy-app.yml']
  workflow_dispatch:

env:
  RG_NAME: rg-case

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get resource names
        id: azure
        run: |
          REGISTRY=$(az acr list --resource-group $RG_NAME --query "[0].name" -o tsv)
          APP_NAME=$(az webapp list --resource-group $RG_NAME --query "[0].name" -o tsv)
          echo "registry=$REGISTRY" >> $GITHUB_OUTPUT
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
        
      - name: Build and push image
        working-directory: backend
        run: |
          VERSION=$([ -f version.txt ] && cat version.txt || echo "0.1.0")
          IFS='.' read -r major minor patch <<< "$VERSION"
          NEW_VERSION="$major.$minor.$((patch + 1))"
          
          az acr build \
            --registry ${{ steps.azure.outputs.registry }} \
            --image question-answer-api:${NEW_VERSION} \
            --image question-answer-api:latest \
            .
          
          echo $NEW_VERSION > version.txt
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          
      - name: Update version in repo
        working-directory: backend
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add version.txt
          git diff --staged --quiet || (
            git commit -m "chore: bump version [skip ci]"
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:${{ github.ref }}
          )

      - name: Deploy to Web App
        run: |
          az webapp config container set \
            --name ${{ steps.azure.outputs.app_name }} \
            --resource-group $RG_NAME \
            --docker-custom-image-name ${{ steps.azure.outputs.registry }}.azurecr.io/question-answer-api:latest \
            --docker-registry-server-url https://${{ steps.azure.outputs.registry }}.azurecr.io
          
          az webapp restart --name ${{ steps.azure.outputs.app_name }} --resource-group $RG_NAME

      - name: Health check
        run: |
          APP_URL=$(az webapp show --name ${{ steps.azure.outputs.app_name }} --resource-group $RG_NAME --query defaultHostName -o tsv)
          
          for i in {1..5}; do
            sleep 12
            if curl -sf https://${APP_URL}/health > /dev/null; then
              echo "✅ Deployment successful!"
              exit 0
            fi
            echo "⏳ Attempt $i/5 failed, retrying..."
          done
          
          echo "❌ Health check failed"
          exit 1

